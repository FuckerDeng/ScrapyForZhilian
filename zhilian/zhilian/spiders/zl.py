# -*- coding: utf-8 -*-
import scrapy
from zhilian.items import ZhilianItem
import json
import copy

class ZlSpider(scrapy.Spider):
    name = 'zl'
    allowed_domains = ['zhaopin.com']
    start_urls = ["https://fe-api.zhaopin.com/c/i/sou?pageSize=90&cityId=801&workExperience=-1&education=-1&companyType=-1&employmentType=-1&jobWelfareTag=-1&kw=Java&kt=3&at=de2dfbab463040df882753264f01818b&rt=5fe88976bdb744a199eb2520637ab506&_v=0.94789694&x-zp-page-request-id=6c846e42b4c94290838ba7730b426cdc-1545965010979-727235&start="]
    cc = "urlfrom=121113803; urlfrom2=121113803; adfbid=0; adfbid2=0; ZP_OLD_FLAG=false; dywea=95841923.70095713074016420.1545964761.1545964761.1545964761.1; dyweb=95841923.13.6.1545964886039; dywec=95841923; dywez=95841923.1545964761.1.1.dywecsr=baidupcpz|dyweccn=(not%20set)|dywecmd=cpt|dywectr=%E6%99%BA%E8%81%94; Hm_lvt_38ba284938d5eddca645bb5e02a02006=1545964761,1545964781; Hm_lpvt_38ba284938d5eddca645bb5e02a02006=1545965012; sts_deviceid=167f2ae31990-00deec5f94b72f-143a7540-2073600-167f2ae319a10c; sts_sg=1; sts_evtseq=17; sts_sid=167f2ae319c633-02e4905ca5d694-143a7540-2073600-167f2ae319d5f1; sts_chnlsid=121113803; zp_src_url=https%3A%2F%2Fsp0.baidu.com%2F9q9JcDHa2gU2pMbgoY3K%2Fadrc.php%3Ft%3D06KL00c00fZmx9C05x-60KqiAsjNWaNT00000Ftg0dC00000VGmmuW.THLyktAJ0A3qPHmsPW0sPj9xP7qsusK15yN-n10vm1P-nj0snjcdrHc0IHdKf10dfbD4fW9DwbwKwHN7fWcdPDnYnRn3nHmYrj64n0K95gTqFhdWpyfqn1DLn1TvP1bznBusThqbpyfqnHm0uHdCIZwsT1CEQLILIz4lpA7ETA-8QhPEUHq1pyfqnHcknHD1rj01FMNYUNq1ULNzmvRqmh7GuZNsmLKlFMNYUNqVuywGIyYqmLKY0APzm1Y1PWD4nf%26tpl%3Dtpl_11535_18778_14772%26l%3D1510152095%26attach%3Dlocation%253D%2526linkName%253D%2525E6%2525A0%252587%2525E5%252587%252586%2525E5%2525A4%2525B4%2525E9%252583%2525A8-%2525E6%2525A0%252587%2525E9%2525A2%252598-%2525E4%2525B8%2525BB%2525E6%2525A0%252587%2525E9%2525A2%252598%2526linkText%253D%2525E3%252580%252590%2525E6%252599%2525BA%2525E8%252581%252594%2525E6%25258B%25259B%2525E8%252581%252598%2525E3%252580%252591%2525E5%2525AE%252598%2525E6%252596%2525B9%2525E7%2525BD%252591%2525E7%2525AB%252599%252520%2525E2%252580%252593%252520%2525E5%2525A5%2525BD%2525E5%2525B7%2525A5%2525E4%2525BD%25259C%2525EF%2525BC%25258C%2525E4%2525B8%25258A%2525E6%252599%2525BA%2525E8%252581%252594%2525E6%25258B%25259B%2525E8%252581%252598%2525EF%2525BC%252581%2526xp%253Did(%252522m3173767922_canvas%252522)%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FDIV%25255B1%25255D%25252FH2%25255B1%25255D%25252FA%25255B1%25255D%2526linkType%253D%2526checksum%253D147%26ie%3Dutf-8%26f%3D8%26ch%3D14%26tn%3D56060048_4_pg%26wd%3D%25E6%2599%25BA%25E8%2581%2594%26oq%3D%25E6%2599%25BA%25E8%2581%2594%26rqlang%3Dcn%26ssl_s%3D1%26ssl_c%3Dssl1_167f2ae1bf0%26h_search_ext%3D%257B%2522count%2522%253A7%252C%2522list%2522%253A%255B%257B%2522txt%2522%253A%2522%255Cu516d%255Cu5c0f%255Cu9f84%255Cu7ae5%255Cu56de%255Cu5e94%255Cu88ab%255Cu9ed1%2522%252C%2522cid%2522%253A%252246606222%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu66fe%255Cu5fd7%255Cu4f1f%255Cu5426%255Cu8ba4%255Cu9189%255Cu9a7e%2522%252C%2522cid%2522%253A%252246594522%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu5218%255Cu8bd7%255Cu8bd7%255Cu6000%255Cu5b55%255Cu540e%255Cu9732%255Cu9762%2522%252C%2522cid%2522%253A%252228673341%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu5b55%255Cu5987%255Cu643a%255Cu81ea%255Cu95ed%255Cu513f%255Cu81ea%255Cu6740%2522%252C%2522cid%2522%253A%252228673347%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu65b9%255Cu5a9b%255Cu90ed%255Cu5bcc%255Cu57ce%255Cu5408%255Cu7167%2522%252C%2522cid%2522%253A%252228673343%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu4ee3%255Cu9a7e%255Cu8eab%255Cu4ea1%2522%252C%2522cid%2522%253A%252228673350%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu7206%255Cu9152%255Cu5e97%255Cu767d%255Cu5e8a%255Cu5355%255Cu6e05%255Cu6d17%2522%252C%2522cid%2522%253A%252228673345%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu90d1%255Cu723d%255Cu4e0e%255Cu7537%255Cu53cb%255Cu88ab%255Cu5076%255Cu9047%2522%252C%2522cid%2522%253A%252228673346%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu8521%255Cu4f9d%255Cu6797%255Cu56de%255Cu5e94%255Cu54ed%255Cu4e86%2522%252C%2522cid%2522%253A%252228673342%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%252C%257B%2522txt%2522%253A%2522%255Cu501f40%255Cu4e07%255Cu6447%255Cu53f7%255Cu8d2d%255Cu623f%2522%252C%2522cid%2522%253A%252228673348%2522%252C%2522sellv%2522%253Anull%252C%2522sell%2522%253Afalse%257D%255D%257D; __xsptplus30=30.2.1545964780.1545964780.1%232%7Csp0.baidu.com%7C%7C%7C%25E6%2599%25BA%25E8%2581%2594%7C%23%238RNetj-oQ8mQWMDLSp7mA69xMh1QBW9J%23; _jzqa=1.3542250640521481000.1545964762.1545964762.1545964762.1; _jzqb=1.4.10.1545964762.1; _jzqc=1; _jzqy=1.1545964762.1545964762.1.jzqsr=baidu|jzqct=%E6%99%BA%E8%81%94.-; _jzqckmp=1; __utma=269921210.16137977.1545964763.1545964763.1545964763.1; __utmb=269921210.13.6.1545964886042; __utmc=269921210; __utmz=269921210.1545964763.1.1.utmcsr=baidupcpz|utmccn=(not%20set)|utmcmd=cpt|utmctr=%E6%99%BA%E8%81%94; __utmt=1; qrcodekey=9a731f395b37413baf580f4d990f6273; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%22708550813%22%2C%22%24device_id%22%3A%22167f2ae4c214d6-0e21c3b082d14d-143a7540-2073600-167f2ae4c2291%22%2C%22props%22%3A%7B%7D%2C%22first_id%22%3A%22167f2ae4c214d6-0e21c3b082d14d-143a7540-2073600-167f2ae4c2291%22%7D; sajssdk_2015_cross_new_user=1; firstchannelurl=https%3A//passport.zhaopin.com/login; lastchannelurl=https%3A//ts.zhaopin.com/jump/index_new.html%3Futm_source%3Dbaidupcpz%26utm_medium%3Dcpt%26utm_provider%3Dpartner%26sid%3D121113803%26site%3Dnull; JsNewlogin=2125652441; JSloginnamecookie=15198228803; JSShowname=; at=de2dfbab463040df882753264f01818b; Token=de2dfbab463040df882753264f01818b; rt=5fe88976bdb744a199eb2520637ab506; JSpUserInfo=2f7927735966526454715d685c6a4f7953735c66546457715e68256a34795e735566506455715c68516a487951735c665d6454715668526a29793773596654645f7124683d6a477952735566486451714568586a4a795973506654645f712468256a477952735f66306425715868236a367953735c66506451715568516a4b79507354665e6431713168546a4b79587337662c6459715568526a7; uiioit=2179306559640f3754770c6450744c7455645c38066444345f6536793065596408375f773; ZL_REPORT_GLOBAL={%22/resume/new%22:{%22actionid%22:%2258aa6dc7-7b7c-4db7-bf71-4970e2d7f32e%22%2C%22funczone%22:%22addrsm_ok_rcm%22}%2C%22sou%22:{%22actionid%22:%224bd89068-50b1-4034-8033-97280d754b18-sou%22%2C%22funczone%22:%22smart_matching%22}}; jobRiskWarning=true; loginreleased=1; LastCity=%E6%88%90%E9%83%BD; LastCity%5Fid=801"
    cookie = ""
    def start_requests(self):
    	self.cookie = {c.split("=")[0]:c.split("=")[1] for c in self.cc.split(";")}
    	for i in range(0,50):
    		newUrl = self.start_urls[0]+str(i*90);
    		yield scrapy.Request(newUrl,cookies = self.cookie,callback = self.parse)

    def parse(self, response):
        js = json.loads(response.text)

        results = js["data"]["results"]
        for r in results:
        	zhilian = ZhilianItem()
        	zhilian["number"] = r["number"]
        	zhilian["jobname"] = r["jobName"]
        	zhilian["company"] = r["company"]["name"]
        	zhilian["position"] = r["city"]["display"]
        	zhilian["size"] = r["company"]["size"]["name"]
        	zhilian["edulevel"] = r["eduLevel"]["name"]
        	zhilian["salary"] = r["salary"]
        	zhilian["workexp"] = r["workingExp"]["name"]
        	workUrl = "https://jobs.zhaopin.com/"+zhilian["number"]+".htm"
        	yield scrapy.Request(workUrl,meta = {"zzll":copy.deepcopy(zhilian)},callback = self.getResult)

    def getResult(self, response):
    	zlItem = response.meta["zzll"]

    	con = response.xpath("//div[@class = 'pos-ul']")[0].xpath("string(.)").extract_first()
    	zlItem["workcontent"] = con
    	return zlItem